<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>قرعه‌کشی طلایی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCOL8YHwIe3OCCeJcZnb03Gsqf3e290QL0",
      authDomain: "ghost-2add0.firebaseapp.com",
      projectId: "ghost-2add0",
      storageBucket: "ghost-2add0.firebasestorage.app",
      messagingSenderId: "765160111148",
      appId: "1:765160111148:web:51b3ccb5d26a6cb1cfe589",
      measurementId: "G-P5KH7K9D48"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase available globally
    window.db = db;
    window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');

    * {
      font-family: 'Vazirmatn', sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .gold-gradient {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    }

    .lottery-animation {
      animation: professionalSpin 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    @keyframes professionalSpin {
      0% {
        transform: rotate(0deg) scale(1);
        box-shadow: 0 10px 30px rgba(139, 69, 19, 0.3);
      }

      25% {
        transform: rotate(360deg) scale(1.05);
        box-shadow: 0 15px 40px rgba(139, 69, 19, 0.4);
      }

      50% {
        transform: rotate(720deg) scale(1.1);
        box-shadow: 0 20px 50px rgba(139, 69, 19, 0.5);
      }

      75% {
        transform: rotate(1080deg) scale(1.05);
        box-shadow: 0 15px 40px rgba(139, 69, 19, 0.4);
      }

      100% {
        transform: rotate(1440deg) scale(1);
        box-shadow: 0 10px 30px rgba(139, 69, 19, 0.3);
      }
    }

    .code-typing {
      animation: typeEffect 0.1s ease-in-out;
    }

    @keyframes typeEffect {
      0% {
        opacity: 0.5;
        transform: scale(0.95);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .code-reveal {
      animation: reveal 0.5s ease-out;
    }

    @keyframes reveal {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .winner-animation {
      animation: celebrate 2s ease-in-out;
    }

    @keyframes celebrate {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    .timer-glow {
      box-shadow: 0 0 30px rgba(246, 211, 101, 0.5);
    }

    /* Mobile App Styles */
    body {
      padding-bottom: 80px;
      /* Space for bottom navigation */
      overflow-x: hidden;
    }

    .mobile-container {
      max-width: 100vw;
      min-height: 100vh;
      position: relative;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1000;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
    }

    .nav-button {
      transition: all 0.3s ease;
    }

    .nav-button:active {
      transform: scale(0.95);
    }

    .nav-button:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Custom Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 24px;
      max-width: 320px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      transform: scale(0.8) translateY(20px);
      transition: all 0.3s ease;
    }

    .modal-overlay.show .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 12px;
    }

    .modal-message {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .modal-button {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .modal-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(246, 211, 101, 0.4);
    }

    .modal-button:active {
      transform: translateY(0);
    }
  </style>
</head>

<body class="gradient-bg min-h-screen">
  <!-- صفحه ثبت نام -->
  <div id="registrationPage" class="mobile-container min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm mx-auto">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">🎉</div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">قرعه‌کشی طلایی</h1>
        <p class="text-gray-600">شانس خود را امتحان کنید!</p>
      </div>

      <!-- تایمر معکوس -->
      <div class="gold-gradient rounded-2xl p-4 mb-6 timer-glow">
        <div class="text-center text-white">
          <p class="text-sm font-medium mb-2">زمان باقی‌مانده تا پایان قرعه‌کشی:</p>
          <div id="countdown" class="text-2xl font-bold"></div>
        </div>
      </div>

      <form id="registrationForm" class="space-y-6">
        <div>
          <label class="block text-gray-700 font-medium mb-2">نام تلگرام</label>
          <input type="text" id="telegramName" required
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-colors"
            placeholder="نام خود در تلگرام را وارد کنید">
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-2">آیدی تلگرام</label>
          <input type="text" id="telegramId" required
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-colors"
            placeholder="@username">
        </div>

        <button type="submit"
          class="w-full gold-gradient text-white font-bold py-4 rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200">
          ثبت نام در قرعه‌کشی
        </button>
      </form>
    </div>
  </div>

  <!-- صفحه اصلی قرعه‌کشی -->
  <div id="mainPage" class="hidden mobile-container min-h-screen p-4">
    <div class="max-w-sm mx-auto">
      <!-- هدر -->
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-white mb-4">🏆 قرعه‌کشی طلایی 🏆</h1>

        <!-- تایمر معکوس -->
        <div class="gold-gradient rounded-2xl p-3 mb-4 timer-glow">
          <div class="text-center text-white">
            <p class="text-xs font-medium mb-1">زمان باقی‌مانده:</p>
            <div id="mainCountdown" class="text-lg font-bold"></div>
          </div>
        </div>
      </div>

      <div class="space-y-6">
        <!-- لیست شرکت‌کنندگان -->
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h2 class="text-lg font-bold text-gray-800 mb-4 text-center">
            شرکت‌کنندگان (<span id="participantCount">0</span> نفر)
          </h2>
          <div id="participantsList" class="space-y-2 max-h-48 overflow-y-auto">
            <!-- لیست شرکت‌کنندگان اینجا نمایش داده می‌شود -->
          </div>
        </div>

        <!-- قسمت قرعه‌کشی -->
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h2 class="text-lg font-bold text-gray-800 mb-4 text-center">قرعه‌کشی</h2>

          <!-- قرعه‌کشی حرفه‌ای -->
          <div class="text-center mb-6">
            <!-- چرخ قرعه‌کشی -->
            <div class="relative mx-auto mb-4" style="width: 150px; height: 150px;">
              <div id="lotteryWheel"
                class="w-full h-full rounded-full border-6 border-gradient-to-r from-purple-500 to-pink-500 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 shadow-xl flex items-center justify-center cursor-pointer hover:shadow-2xl transition-all duration-300">
                <div class="w-24 h-24 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                  <div class="w-16 h-16 rounded-full bg-white/30 backdrop-blur-sm flex items-center justify-center">
                    <div class="w-8 h-8 rounded-full bg-white/40 backdrop-blur-sm"></div>
                  </div>
                </div>
              </div>
              <!-- نشانگر -->
              <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1">
                <div
                  class="w-0 h-0 border-l-3 border-r-3 border-b-6 border-l-transparent border-r-transparent border-b-yellow-400">
                </div>
              </div>
            </div>

            <!-- نمایش کد انتخاب شده -->
            <div class="mb-4">
              <div class="bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl p-4 mb-3">
                <p class="text-xs text-gray-600 mb-1">کد انتخاب شده:</p>
                <div id="selectedCode"
                  class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 min-h-[2rem] flex items-center justify-center">
                  آماده قرعه‌کشی
                </div>
              </div>
            </div>

            <button id="startLottery" disabled
              class="bg-gray-400 text-gray-600 font-bold py-3 px-6 rounded-xl cursor-not-allowed opacity-50 text-sm">
              قرعه‌کشی فقط خودکار انجام می‌شود
            </button>
          </div>

          <!-- جوایز حرفه‌ای -->
          <div class="mb-4">
            <h3 class="text-sm font-bold text-gray-700 mb-3 text-center">جوایز مسابقه</h3>
            <div class="grid grid-cols-3 gap-2">
              <div
                class="bg-gradient-to-r from-yellow-400 to-orange-500 p-2 rounded-lg text-white text-center shadow-md">
                <div class="font-bold text-sm">150K</div>
                <div class="text-xs opacity-90">تومان</div>
              </div>
              <div class="bg-gradient-to-r from-green-400 to-blue-500 p-2 rounded-lg text-white text-center shadow-md">
                <div class="font-bold text-sm">500K</div>
                <div class="text-xs opacity-90">تومان</div>
              </div>
              <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-2 rounded-lg text-white text-center shadow-md">
                <div class="font-bold text-sm">1.5M</div>
                <div class="text-xs opacity-90">تومان</div>
              </div>
              <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-2 rounded-lg text-white text-center shadow-md">
                <div class="font-bold text-sm">PS5</div>
                <div class="text-xs opacity-90">کنسول</div>
              </div>
              <div
                class="bg-gradient-to-r from-yellow-300 to-yellow-500 p-2 rounded-lg text-white text-center shadow-md">
                <div class="font-bold text-sm">🍌 10K</div>
                <div class="text-xs opacity-90">موز</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- برندگان -->
      <div class="bg-white rounded-2xl shadow-xl p-4">
        <h2 class="text-lg font-bold text-gray-800 mb-4 text-center">🏆 برندگان</h2>
        <div id="winnersList" class="grid grid-cols-1 gap-3">
          <!-- برندگان اینجا نمایش داده می‌شوند -->
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="flex items-center justify-center h-16">
      <button onclick="goToHome()"
        class="nav-button flex flex-col items-center justify-center px-6 py-2 rounded-xl text-white">
        <div class="text-xl mb-1">🏠</div>
        <div class="text-xs font-medium">بازگشت به خانه</div>
      </button>
    </div>
  </div>

  <!-- Custom Modal -->
  <div id="customModal" class="modal-overlay">
    <div class="modal-content">
      <div id="modalIcon" class="modal-icon">ℹ️</div>
      <div id="modalTitle" class="modal-title">عنوان پیام</div>
      <div id="modalMessage" class="modal-message">متن پیام اینجا نمایش داده می‌شود</div>
      <button id="modalButton" class="modal-button" onclick="closeModal()">باشه</button>
    </div>
  </div>

  <script>
    // داده‌های برنامه - Firebase Database
    let participants = [];
    let winners = [];
    let codeCounter = 100;

    // Firebase Collections
    const PARTICIPANTS_COLLECTION = 'participants';
    const WINNERS_COLLECTION = 'winners';

    // بارگذاری داده‌ها از Firebase
    async function loadAllData() {
      try {
        // بارگذاری شرکت‌کنندگان
        const participantsQuery = window.firestore.query(
          window.firestore.collection(window.db, PARTICIPANTS_COLLECTION),
          window.firestore.orderBy('timestamp', 'desc')
        );
        const participantsSnapshot = await window.firestore.getDocs(participantsQuery);
        participants = [];
        participantsSnapshot.forEach((doc) => {
          participants.push({ id: doc.id, ...doc.data() });
        });

        // بارگذاری برندگان
        const winnersQuery = window.firestore.query(
          window.firestore.collection(window.db, WINNERS_COLLECTION),
          window.firestore.orderBy('timestamp', 'desc')
        );
        const winnersSnapshot = await window.firestore.getDocs(winnersQuery);
        winners = [];
        winnersSnapshot.forEach((doc) => {
          winners.push({ id: doc.id, ...doc.data() });
        });

        updateParticipantsList();
        updateWinnersList();
      } catch (error) {
        console.error('خطا در بارگذاری داده‌ها:', error);
        showModal(
          'خطا در اتصال',
          'مشکلی در اتصال به سرور پیش آمده. لطفاً دوباره تلاش کنید.',
          '⚠️'
        );
      }
    }

    // ذخیره شرکت‌کننده جدید در Firebase
    async function saveParticipant(participant) {
      try {
        const docRef = await window.firestore.addDoc(
          window.firestore.collection(window.db, PARTICIPANTS_COLLECTION),
          {
            ...participant,
            timestamp: new Date()
          }
        );
        console.log('شرکت‌کننده با موفقیت ذخیره شد:', docRef.id);
        return true;
      } catch (error) {
        console.error('خطا در ذخیره شرکت‌کننده:', error);
        return false;
      }
    }

    // ذخیره برنده جدید در Firebase
    async function saveWinner(winner) {
      try {
        const docRef = await window.firestore.addDoc(
          window.firestore.collection(window.db, WINNERS_COLLECTION),
          {
            ...winner,
            timestamp: new Date()
          }
        );
        console.log('برنده با موفقیت ذخیره شد:', docRef.id);
        return true;
      } catch (error) {
        console.error('خطا در ذخیره برنده:', error);
        return false;
      }
    }

    // Real-time listener برای شرکت‌کنندگان
    function setupParticipantsListener() {
      const participantsQuery = window.firestore.query(
        window.firestore.collection(window.db, PARTICIPANTS_COLLECTION),
        window.firestore.orderBy('timestamp', 'desc')
      );

      window.firestore.onSnapshot(participantsQuery, (snapshot) => {
        participants = [];
        snapshot.forEach((doc) => {
          participants.push({ id: doc.id, ...doc.data() });
        });
        updateParticipantsList();
      });
    }

    // Real-time listener برای برندگان
    function setupWinnersListener() {
      const winnersQuery = window.firestore.query(
        window.firestore.collection(window.db, WINNERS_COLLECTION),
        window.firestore.orderBy('timestamp', 'desc')
      );

      window.firestore.onSnapshot(winnersQuery, (snapshot) => {
        winners = [];
        snapshot.forEach((doc) => {
          winners.push({ id: doc.id, ...doc.data() });
        });
        updateWinnersList();
      });
    }

    const prizes = [
      "💰 150 هزار تومان",
      "💎 500 هزار تومان",
      "🏆 1.5 میلیون تومان",
      "🎮 کنسول PS5",
      "🍌 10,000 تا موز"
    ];

    // تایمر معکوس هفتگی (شنبه تا جمعه) - شروع از شنبه
    function updateCountdown() {
      const now = new Date();

      // شبیه‌سازی زمان ایران (فرض می‌کنیم الان دوشنبه است)
      // هفته از شنبه شروع می‌شه و جمعه تموم می‌شه
      // کل هفته = 7 روز = 7 * 24 * 60 * 60 * 1000 میلی‌ثانیه
      const weekDuration = 7 * 24 * 60 * 60 * 1000;

      // فرض می‌کنیم شنبه گذشته ساعت 00:00 شروع شده
      // و امروز دوشنبه است (2 روز از شنبه گذشته)
      const weekStart = new Date();
      weekStart.setDate(weekStart.getDate() - 2); // 2 روز قبل (شنبه)
      weekStart.setHours(0, 0, 0, 0);

      // پایان هفته: جمعه شب ساعت 23:59
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6); // 6 روز بعد از شنبه = جمعه
      weekEnd.setHours(23, 59, 59, 999);

      const distance = weekEnd.getTime() - now.getTime();

      if (distance > 0) {
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        const timeString = `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        document.getElementById('countdown').innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold mb-1">${timeString}</div>
                        <div class="text-xs opacity-75">روز:ساعت:دقیقه:ثانیه</div>
                    </div>
                `;
        document.getElementById('mainCountdown').innerHTML = `
                    <div class="text-center">
                        <div class="text-lg font-bold mb-1">${timeString}</div>
                        <div class="text-xs opacity-75">روز:ساعت:دقیقه:ثانیه</div>
                    </div>
                `;
      } else {
        // اگر زمان تمام شده، نمایش پیام پایان و قرعه‌کشی خودکار
        document.getElementById('countdown').innerHTML = `
                    <div class="text-center">
                        <div class="text-lg font-bold mb-1">00:00:00:00</div>
                        <div class="text-xs opacity-75">قرعه‌کشی این هفته به پایان رسیده</div>
                    </div>
                `;
        document.getElementById('mainCountdown').innerHTML = `
                    <div class="text-center">
                        <div class="text-sm font-bold mb-1">00:00:00:00</div>
                        <div class="text-xs opacity-75">قرعه‌کشی این هفته به پایان رسیده</div>
                    </div>
                `;

        // اگر شرکت‌کننده داریم، قرعه‌کشی خودکار انجام بده
        if (participants.length > 0 && !document.querySelector('.auto-lottery-done')) {
          // علامت‌گذاری که قرعه‌کشی خودکار انجام شده
          document.body.classList.add('auto-lottery-done');

          setTimeout(() => {
            performAutomaticLottery();
          }, 2000);
        }

        // بعد از 10 ثانیه، شروع دوره جدید (شنبه هفته بعد)
        setTimeout(() => {
          // پاک کردن فقط localStorage
          localStorage.removeItem('userRegistered');
          localStorage.removeItem('userTelegramId');
          document.body.classList.remove('auto-lottery-done');

          // بازگشت به صفحه ثبت‌نام
          document.getElementById('mainPage').classList.add('hidden');
          document.getElementById('registrationPage').classList.remove('hidden');

          // نمایش پیام شروع دوره جدید
          showModal(
            'دوره جدید شروع شد!',
            'دوره جدید قرعه‌کشی شروع شد!\n\nمی‌توانید مجدداً ثبت‌نام کنید.',
            '🆕'
          );
        }, 10000);
      }
    }

    // بررسی ثبت‌نام قبلی هنگام بارگذاری صفحه
    window.addEventListener('load', async function () {
      // صبر تا Firebase آماده شود
      setTimeout(async () => {
        // بارگذاری همه داده‌ها از Firebase
        await loadAllData();

        // راه‌اندازی Real-time listeners
        setupParticipantsListener();
        setupWinnersListener();

        const userRegistered = localStorage.getItem('userRegistered');
        if (userRegistered === 'true') {
          document.getElementById('registrationPage').classList.add('hidden');
          document.getElementById('mainPage').classList.remove('hidden');
        }
      }, 1000);
    });

    // ثبت نام
    document.getElementById('registrationForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const name = document.getElementById('telegramName').value;
      const id = document.getElementById('telegramId').value;

      if (name && id) {
        // بررسی اینکه آیا این کاربر قبلاً ثبت‌نام کرده یا نه
        const existingUser = participants.find(p => p.telegramId === id);
        if (existingUser) {
          showModal(
            'قبلاً ثبت‌نام کرده‌اید!',
            `شما قبلاً با کد ${existingUser.code} ثبت‌نام کرده‌اید!`,
            '⚠️'
          );
          setTimeout(() => {
            document.getElementById('registrationPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
          }, 2000);
          return;
        }

        // تولید کد رندوم 3 رقمی
        let randomCode;
        do {
          randomCode = '#' + Math.floor(Math.random() * 900 + 100).toString();
        } while (participants.some(p => p.code === randomCode)); // اطمینان از یکتا بودن کد

        const code = randomCode;

        const participant = {
          name: name,
          telegramId: id,
          code: code
        };

        // ذخیره در Firebase
        const saved = await saveParticipant(participant);

        if (saved) {
          localStorage.setItem('userRegistered', 'true');
          localStorage.setItem('userTelegramId', id);

          showModal(
            'ثبت‌نام موفق!',
            `کد شما: ${code}\n\nحالا می‌توانید در قرعه‌کشی شرکت کنید!`,
            '🎉'
          );

          setTimeout(() => {
            document.getElementById('registrationPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
          }, 2000);
        } else {
          showModal(
            'خطا در ثبت‌نام',
            'مشکلی در ثبت‌نام پیش آمده. لطفاً دوباره تلاش کنید.',
            '❌'
          );
        }
      }
    });

    // به‌روزرسانی لیست شرکت‌کنندگان
    function updateParticipantsList() {
      const list = document.getElementById('participantsList');
      const count = document.getElementById('participantCount');

      count.textContent = participants.length;

      list.innerHTML = participants.map(p => `
                <div class="bg-gray-50 p-2 rounded-lg flex justify-between items-center">
                    <div>
                        <div class="font-medium text-sm">${p.name}</div>
                        <div class="text-xs text-gray-600">${p.telegramId}</div>
                    </div>
                    <div class="font-bold text-purple-600 text-sm">${p.code}</div>
                </div>
            `).join('');
    }

    // دکمه قرعه‌کشی غیرفعال است - فقط قرعه‌کشی خودکار انجام می‌شود
    document.getElementById('startLottery').addEventListener('click', function () {
      showModal(
        'قرعه‌کشی خودکار',
        'قرعه‌کشی فقط در پایان هفته به صورت خودکار انجام می‌شود!\n\nصبر کنید تا تایمر به پایان برسد.',
        '⏰'
      );
    });

    // به‌روزرسانی لیست برندگان
    function updateWinnersList() {
      const list = document.getElementById('winnersList');

      list.innerHTML = winners.map(w => {
        // تبدیل timestamp به فرمت قابل خواندن
        let displayTime = w.timestamp;
        if (w.timestamp && w.timestamp.toDate) {
          displayTime = w.timestamp.toDate().toLocaleString('fa-IR');
        } else if (w.timestamp instanceof Date) {
          displayTime = w.timestamp.toLocaleString('fa-IR');
        }

        return `
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 p-3 rounded-xl text-white winner-animation">
                        <div class="text-center">
                            <div class="text-xl mb-1">🏆</div>
                            <div class="font-bold text-sm">${w.name}</div>
                            <div class="text-xs opacity-90">${w.telegramId}</div>
                            <div class="text-xs opacity-90">${w.code}</div>
                            <div class="mt-1 font-bold text-sm">${w.prize}</div>
                            <div class="text-xs opacity-75 mt-1">${displayTime}</div>
                        </div>
                    </div>
                `;
      }).join('');
    }

    // قرعه‌کشی خودکار وقتی تایمر تموم شد
    function performAutomaticLottery() {
      if (participants.length === 0) return;

      showModal(
        'شروع قرعه‌کشی!',
        'زمان به پایان رسید! قرعه‌کشی خودکار شروع می‌شود...',
        '⏰'
      );

      setTimeout(() => {
        closeModal();

        const wheel = document.getElementById('lotteryWheel');
        const codeDisplay = document.getElementById('selectedCode');
        const button = document.getElementById('startLottery');

        // غیرفعال کردن دکمه
        button.disabled = true;
        button.textContent = 'قرعه‌کشی خودکار...';
        button.classList.add('opacity-50', 'cursor-not-allowed');

        wheel.classList.add('lottery-animation');
        codeDisplay.textContent = 'در حال انتخاب برنده نهایی...';

        // نمایش کدهای مختلف به صورت حرفه‌ای
        let counter = 0;
        let speed = 100;
        const showCodes = setInterval(() => {
          const randomParticipant = participants[Math.floor(Math.random() * participants.length)];
          codeDisplay.textContent = randomParticipant.code;
          codeDisplay.classList.add('code-typing');

          setTimeout(() => {
            codeDisplay.classList.remove('code-typing');
          }, 50);

          counter++;
          speed += 20;

          if (counter > 20) {
            clearInterval(showCodes);
          }
        }, speed);

        setTimeout(() => {
          // انتخاب برنده نهایی
          const randomIndex = Math.floor(Math.random() * participants.length);
          const winner = participants[randomIndex];
          const randomPrize = "🍌 10,000 تا موز";

          codeDisplay.textContent = winner.code;
          codeDisplay.classList.add('code-reveal');

          const winnerData = {
            ...winner,
            prize: randomPrize,
            timestamp: new Date().toLocaleString('fa-IR'),
            isAutoWinner: true
          };

          // ذخیره برنده در Firebase
          async function handleWinner() {
            await saveWinner(winnerData);
            console.log("برنده ذخیره شد!");
          }

          // صدا زدن تابع
          handleWinner();


          setTimeout(() => {
            showModal(
              'برنده نهایی این هفته! 🎉',
              `برنده: ${winner.name}\nکد: ${winner.code}\nجایزه: ${randomPrize}\n\n🏆 تبریک می‌گوییم!`,
              '🏆'
            );

            // فعال کردن مجدد دکمه
            button.disabled = false;
            button.textContent = 'شروع قرعه‌کشی';
            button.classList.remove('opacity-50', 'cursor-not-allowed');
          }, 1000);

          wheel.classList.remove('lottery-animation');
          setTimeout(() => {
            codeDisplay.classList.remove('code-reveal');
          }, 500);
        }, 4000);
      }, 2000);
    }

    // شروع تایمر
    updateCountdown();
    setInterval(updateCountdown, 1000);

    // تابع بازگشت به خانه
    function goToHome() {
      window.location.href = 'index.html';
    }

    // Custom Modal Functions
    function showModal(title, message, icon = 'ℹ️', buttonText = 'باشه') {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      document.getElementById('modalIcon').textContent = icon;
      document.getElementById('modalButton').textContent = buttonText;
      document.getElementById('customModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('customModal').classList.remove('show');
    }

    // Close modal when clicking outside
    document.getElementById('customModal').addEventListener('click', function (e) {
      if (e.target === this) {
        closeModal();
      }
    });
  </script>
  <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'97c8a935030cefe4',t:'MTc1NzQ0MTYyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>