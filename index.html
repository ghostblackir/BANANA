<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>گردونه حرفه‌ای</title>
<link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.003/font-face.css" rel="stylesheet">
<style>
:root {
  --bg: #1f1b24;
  --panel: #2b2730;
  --accent: #f7c948;
  --accent-dark: #e0b323;
  --text: #fff;
}
html, body {margin:0; padding:0; font-family: Vazirmatn, sans-serif; background: var(--bg); height:100%; display:flex; flex-direction:column;}
.shell {flex:1; display:flex; flex-direction:column;}
.content {flex:1; overflow:auto; padding:16px;}
.panel {background: var(--panel); border-radius:16px; padding:16px; margin-bottom:12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);}
.bottom-nav {display:flex; justify-content:space-around; padding:8px 0; border-top:2px solid var(--accent-dark); background: var(--panel);}
.bottom-nav button {flex:1; border:none; background:none; color:var(--text); display:flex; flex-direction:column; align-items:center; font-size:12px; gap:4px; cursor:pointer;}
.bottom-nav button.active {color: var(--accent); font-weight:bold;}
#wheelCanvas {display:block; margin:auto; border:5px solid var(--accent); border-radius:50%; background: #3b2f0b;}
.btn {padding:10px; border:none; border-radius:12px; font-weight:bold; cursor:pointer; background:var(--accent); color:var(--text); width:100%; margin-top:12px;}
#userStats {display:flex; justify-content:space-around; margin-bottom:16px; font-weight:bold;}
.hidden {display:none;}
table {width:100%; border-collapse:collapse; margin-top:12px;}
th, td {padding:8px; border-bottom:1px solid #555; text-align:right;}
</style>
</head>
<body>
<div class="shell">
  <div class="content">
    <!-- HOME -->
    <div id="homeTab">
      <div class="panel">
        <h2 style="text-align:center;">🎡 گردونه موز حرفه‌ای</h2>
        <div id="userStats">
          <div>💰 موز: <span id="coins">0</span></div>
          <div>💵 قیمت بعدی چرخش: <span id="spinPrice">10000</span> تومان</div>
        </div>
        <canvas id="wheelCanvas" width="300" height="300"></canvas>
        <button class="btn" id="spinButton">چرخش گردونه</button>
        <p id="result" style="text-align:center; font-weight:bold; margin-top:12px;"></p>
      </div>
    </div>

    <!-- STORE -->
    <div id="storeTab" class="hidden">
      <div class="panel">
        <h2>💎 فروشگاه موز</h2>
        <p>با موزها می‌توانید خدمات اضافه کنید</p>
        <div id="storeItems"></div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="profileTab" class="hidden">
      <div class="panel">
        <h2>👤 پروفایل شما</h2>
        <div id="walletStatus">کیف پول متصل نیست</div>
        <h3>تراکنش‌ها</h3>
        <table>
          <thead><tr><th>تاریخ</th><th>جایزه</th></tr></thead>
          <tbody id="transactions"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <button id="tabHome" class="active">خانه</button>
    <button id="tabStore">فروشگاه</button>
    <button id="tabProfile">پروفایل</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCOL8YHwIe3OCCeJcZnb03Gsqf3e290QL0",
  authDomain: "ghost-2add0.firebaseapp.com",
  projectId: "ghost-2add0",
  storageBucket: "ghost-2add0.firebasestorage.app",
  messagingSenderId: "765160111148",
  appId: "1:765160111148:web:51b3ccb5d26a6cb1cfe589",
  measurementId: "G-P5KH7K9D48"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const userID = "user_x"; // شناسه کاربر

// Tabs
const tabs = { homeTab: document.getElementById('homeTab'), storeTab: document.getElementById('storeTab'), profileTab: document.getElementById('profileTab')};
function switchTab(tabId){
  Object.values(tabs).forEach(t=>t.classList.add('hidden'));
  tabs[tabId].classList.remove('hidden');
  document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab'+tabId.replace('Tab','')).classList.add('active');
}
document.getElementById('tabHome').addEventListener('click',()=>switchTab('homeTab'));
document.getElementById('tabStore').addEventListener('click',()=>switchTab('storeTab'));
document.getElementById('tabProfile').addEventListener('click',()=>switchTab('profileTab'));

// Wheel
const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');
const center = canvas.width / 2;
const radius = center - 10;
const segments = ["100 موز","150 موز","200 موز","250 موز","1000 موز"];
const colors = ["#ffe066","#ffd633","#ffc107","#ffb300","#ffa000"];

let coins = 0, angle = 0, spinning = false, spinSpeed = 0;
let spinPrice = 10000;

// ایجاد یا بارگذاری کاربر
async function createUserIfNotExist() {
  const userRef = doc(db, "users", userID);
  const userSnap = await getDoc(userRef);
  if(!userSnap.exists()){
    await setDoc(userRef, { coins:0, wheelUnlocked:false, transactions:[], spinPrice:10000 });
  } else {
    const data = userSnap.data();
    coins = data.coins;
    spinPrice = data.spinPrice || 10000;
    document.getElementById('coins').textContent = coins;
    document.getElementById('spinPrice').textContent = spinPrice;
    updateTransactions(data.transactions);
  }
}
createUserIfNotExist();

function drawWheel(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const segAngle = 2*Math.PI/segments.length;
  segments.forEach((text,i)=>{
    ctx.beginPath();
    ctx.moveTo(center,center);
    ctx.arc(center,center,radius,i*segAngle+angle,(i+1)*segAngle+angle);
    ctx.fillStyle = colors[i%colors.length]; ctx.fill();
    ctx.save(); ctx.translate(center,center); ctx.rotate(i*segAngle+segAngle/2+angle);
    ctx.fillStyle='#1f1b24'; ctx.textAlign='right'; ctx.font='bold 14px Vazirmatn'; ctx.fillText(text,radius-10,5);
    ctx.restore();
  });
  ctx.fillStyle='#fff'; ctx.beginPath(); ctx.moveTo(center-10,0); ctx.lineTo(center+10,0); ctx.lineTo(center,20); ctx.closePath(); ctx.fill();
}

function updateTransactions(trans){
  const tbody = document.getElementById('transactions');
  tbody.innerHTML = "";
  trans?.forEach(t=>{
    const date = t.timestamp ? new Date(t.timestamp).toLocaleString() : "-";
    tbody.innerHTML += `<tr><td>${date}</td><td>${t.reward}</td></tr>`;
  });
}

function handleResult(selected){
  const reward = segments[selected];
  coins += parseInt(reward);
  document.getElementById('coins').textContent = coins;
  document.getElementById('result').textContent = `🎉 برنده شدی: ${reward}!`;
}

// ذخیره تراکنش بدون ارور Firebase
async function saveTransaction(selected){
  const userRef = doc(db, "users", userID);
  const trans = { reward: segments[selected], timestamp: Date.now() };
  spinPrice += 10000; // افزایش قیمت بعد از هر بار
  await updateDoc(userRef, {
    coins: coins,
    wheelUnlocked:false,
    spinPrice: spinPrice,
    transactions: arrayUnion(trans)
  });
  updateTransactions([...(await getDoc(userRef)).data().transactions]);
  document.getElementById('spinPrice').textContent = spinPrice;
}

// انیمیشن چرخش
function animate(){
  if(spinning){
    angle += spinSpeed;
    spinSpeed *= 0.97;
    if(spinSpeed < 0.002){
      spinning=false;
      spinSpeed=0;
      const segAngle = 2*Math.PI/segments.length;
      let adjustedAngle = (3*Math.PI/2 - angle) % (2*Math.PI);
      if(adjustedAngle<0) adjustedAngle += 2*Math.PI;
      let selected = Math.floor(adjustedAngle / segAngle);
      handleResult(selected);
      saveTransaction(selected);
    }
  }
  drawWheel();
  requestAnimationFrame(animate);
}
animate();

// چرخش گردونه فقط وقتی فعال
document.getElementById('spinButton').addEventListener('click', async ()=>{
  const userRef = doc(db, "users", userID);
  const userSnap = await getDoc(userRef);
  if(!userSnap.exists()) return alert("کاربر وجود ندارد!");
  const userData = userSnap.data();
  if(!userData.wheelUnlocked) return alert("گردونه فعال نیست! از ادمین بخواهید فعال کند.");
  if(!spinning){
    spinning = true;
    spinSpeed = 0.3 + Math.random()*0.2;
    document.getElementById('result').textContent = '';
  }
});
</script>
</body>
</html>
